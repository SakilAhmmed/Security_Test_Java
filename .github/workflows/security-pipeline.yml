name: Java Maven Security Pipeline

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
      ##############################
      # 1️⃣ Checkout code
      ##############################
      - name: Checkout repository
        uses: actions/checkout@v4

    

      ##############################
      # 4️⃣ Quick Maven Dependency Scan (Trivy)
      ##############################
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh
      
      - name: Run Trivy (Maven Dependency Scan)
        run: trivy fs . --scanners vuln --dependency-file pom.xml --format sarif --output trivy.sarif || true

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy.sarif

      ##############################
      # 5️⃣ Deep Maven Dependency Scan (OWASP Dependency-Check)
      ##############################
      - name: Build Maven project
        run: mvn clean install -DskipTests
      
      - name: Copy dependencies
        run: mvn dependency:copy-dependencies -DoutputDirectory=target/dependency
      
      - name: Install OWASP Dependency-Check
        run: |
          curl -L https://github.com/jeremylong/DependencyCheck/releases/download/v8.0.2/dependency-check-8.0.2-release.zip -o dependency-check.zip
          unzip dependency-check.zip -d dependency-check
          chmod +x dependency-check/bin/dependency-check.sh
      
      - name: Run Dependency-Check CLI (full scan)
        run: |
          ./dependency-check/bin/dependency-check.sh \
            --project "spring-boot-firstapplication" \
            --scan target/dependency \
            --format SARIF \
            --out ./dependency-check-report \
            --enableExperimental || true
      
      - name: Upload Dependency-Check SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ./dependency-check-report/dependency-check-report.sarif

      ##############################
      # 2️⃣ Secret Scanning (Gitleaks)
      ##############################
      - name: Run Gitleaks (Secret Scan)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --report-format sarif --report-path gitleaks.sarif

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

      ##############################
      # 3️⃣ SAST Scanning (Semgrep for Java)
      ##############################
      - name: Setup Python (for Semgrep)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep (Java rules)
        run: semgrep scan --config=p/java --sarif --output semgrep.sarif

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
